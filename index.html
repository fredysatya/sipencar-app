<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIPENCAR - Arsip Digital KPU</title>

  <!-- Icon & Manifest -->
  <link rel="icon" type="image/png" href="LogoSipencar.png">
  <link rel="apple-touch-icon" href="LogoSipencar-180.png">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#990000">

  <!-- Bootstrap & Font -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Roboto', sans-serif; background: #f4f6f8; padding-bottom: 60px; }
    .header-app {
      background: linear-gradient(160deg,#990000 0%,#660000 100%);
      color:white; padding:40px 20px 60px 20px; border-bottom-left-radius:25px; border-bottom-right-radius:25px;
      text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.25);
    }
    .logo-container { background:white; width:80px; height:80px; border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 8px rgba(0,0,0,0.2); overflow:hidden; }
    .logo-kpu { width:100%; height:100%; object-fit:contain; }
    .header-title-main { font-weight:900; font-size:1.3rem; line-height:1.2; text-shadow:0 2px 4px rgba(0,0,0,0.3); }
    .header-subtitle { font-weight:700; font-size:1.1rem; margin-top:5px; text-transform:uppercase; letter-spacing:0.5px; }
    .header-small { font-size:0.85rem; color:#e0e0e0; margin-top:5px; font-weight:400; opacity:0.9; line-height:1.4; }
    .search-container { margin-top:-25px; padding:0 20px; }
    .search-box { background:white; padding:10px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.08); display:flex; gap:10px; }
    .search-input { border:1px solid #eee; background:#fcfcfc; border-radius:8px; flex-grow:1; padding:12px 15px; font-size:16px; outline:none; }
    .search-btn { background-color:#212529; color:white; border:none; border-radius:8px; padding:0 20px; font-weight:600; }
    .card-result { background:white; border-radius:12px; border:1px solid #dee2e6; box-shadow:0 4px 8px rgba(0,0,0,0.05); margin-bottom:20px; overflow:hidden; }
    .btn-aksi { background-color: #198754; color:white; font-weight:600; padding:10px 20px; border-radius:8px; display:inline-block; text-align:center; width:100%; margin-top:10px; text-decoration:none; transition:background 0.3s; }
    .btn-aksi:hover { background-color:#146c43; }
    .result-count { text-align:center; margin-top:20px; font-size:0.9rem; color:#666; }
  </style>
</head>
<body>

  <div class="header-app">
    <div class="logo-container">
      <img src="LogoSipencar.png" alt="Logo KPU" class="logo-kpu">
    </div>
    <div class="header-title-main">SIPENCAR</div>
    <div class="header-subtitle">Sistem Pencarian Arsip</div>
    <div class="header-small">Sub Bagian Teknis Penyelenggaraan Pemilu KPU Provinsi Bali</div>
  </div>

  <div class="container" style="max-width:700px; margin-top:20px;">
    <div class="search-container">
      <form id="searchForm">
        <div class="search-box">
          <input type="text" id="keyword" class="search-input" placeholder="Cari dokumen...">
          <button type="submit" class="search-btn">CARI</button>
        </div>
      </form>
    </div>

    <div id="loading" class="text-center my-4" style="display:none;">
      <div class="spinner-border text-danger" role="status"></div>
      <p class="small text-muted mt-2">Sedang memuat...</p>
    </div>

    <div id="resultCount" class="result-count"></div>
    <div id="hasilPencarian"></div>
  </div>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log("Service Worker terdaftar"));
    }
  </script>

  <!-- beforeinstallprompt untuk PWA -->
  <script>
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault(); // cegah prompt otomatis
      deferredPrompt = e;
      // munculkan tombol install asli
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(choice => {
        console.log("User choice:", choice.outcome);
      });
    });
  </script>

  <!-- Fungsi pencarian via Apps Script -->
<script>
    const form = document.getElementById('searchForm');
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const keyword = document.getElementById('keyword').value.trim();
      if(!keyword) return;

      // 1. Reset Tampilan (Tampilkan loading, kosongkan hasil lama)
      document.getElementById('loading').style.display='block';
      document.getElementById('hasilPencarian').innerHTML='';
      document.getElementById('resultCount').innerText='';

      try {
        // ==========================================
        // BAGIAN KODE BARU DIMULAI DARI SINI
        // ==========================================
        
        // URL Web App Script Anda (Pastikan akhiran /exec)
        const scriptURL = "https://script.google.com/macros/s/AKfycbyhvSJ981oLg991cBFd1CsLpvoNiwT836tn8rKEOXw8GH9umxpyvrQzVuUtxG6kfbC6/exec";
        
        // Tambahkan parameter keyword ke URL
        const url = `${scriptURL}?keyword=${encodeURIComponent(keyword)}`;

        // Lakukan Fetch Data
        const res = await fetch(url);

        // Cek jika ada error dari server
        if (!res.ok) throw new Error("Gagal menghubungi server (HTTP " + res.status + ")");

        // Ubah hasil menjadi JSON
        const data = await res.json();

        // ==========================================
        // LOGIKA RENDERING (MENAMPILKAN HASIL)
        // ==========================================
        
        document.getElementById('loading').style.display='none';
        const container = document.getElementById('hasilPencarian');
        const countLabel = document.getElementById('resultCount');

        // Jika data kosong / tidak ditemukan
        if(!data || data.length === 0){
          countLabel.innerText = "Tidak ditemukan dokumen.";
          container.innerHTML='<p class="text-center text-muted py-5">Coba kata kunci lain.</p>';
          return;
        }

        // Jika data ada
        countLabel.innerText = `Ditemukan ${data.length} dokumen:`;

        // Loop untuk membuat kartu dokumen
        data.forEach(item => {
          const card = document.createElement('div');
          card.className = 'card-result';
          
          let html = `<div class="card-body"><div class="doc-title">${item.nama}</div>`;
          
          if(item.ringkasan) {
            html += `<div class="doc-desc">${item.ringkasan}</div>`;
          }
          
          // Cek apakah link valid (http/https)
          if(item.link && (item.link.includes('http') || item.link.includes('www'))){
            html += `<a href="${item.link}" target="_blank" class="btn-aksi">üìÑ Lihat / Unduh File</a>`;
          } else if(item.link && item.link.trim() !== ""){
            html += `<div class="mt-2 text-muted" style="font-size:0.9rem">‚ÑπÔ∏è Info: ${item.link}</div>`;
          } else {
            html += `<div class="mt-2 text-muted" style="font-size:0.9rem">üîí File digital belum tersedia</div>`;
          }
          
          html += `</div>`;
          card.innerHTML = html;
          container.appendChild(card);
        });

      } catch(err){
        // Jika terjadi error (misal koneksi putus)
        document.getElementById('loading').style.display='none';
        console.error(err);
        alert("Terjadi kesalahan: " + err.message);
      }
    });
  </script>

</body>
</html>
